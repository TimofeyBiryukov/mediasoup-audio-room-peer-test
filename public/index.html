<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>SFU Test</title>
  <script src="socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="js/mediasoupclient.min.js"></script>
</head>
<body>
  <button onclick="produce()">Send Audio</button>

  <div id="remoteAudios"></div>

  <script>
    const socket = io('/');
    
    socket.request = function request(type, data = {}) {
      return new Promise((resolve, reject) => {
        socket.emit(type, data, (data) => {
          if (data.error) {
            reject(data.error);
          } else {
            resolve(data);
          }
        });
      });
    };

    const api = axios.create({
      baseUrl: '/'
    });

    const device = new mediasoupClient.Device();
    let producerTransport = null;
    let consumerTransport = null;

    const ROOM_ID = 1;

    (async () => {
      // create room
      await api.post('/room', {roomId: ROOM_ID});
      // join room
      await socket.emit('join', {
        roomId: ROOM_ID,
        userId: Math.round(Math.random() * 10000000)
      });
      socket.emit('getProducers');
      const routerRtpCapabilities = await socket
        .request('getRouterRtpCapabilities');
      await device.load({routerRtpCapabilities});
      await initTransports();
    })();

    socket.on('newProducers', async data => {
      console.log('New producers', data);
      for (const {producerId} of data) {
        await consume(producerId);
      }
    });

    async function initTransports() {
      const producerTransportParams = await socket
        .request('createWebRtcTransport');

      producerTransport = device.createSendTransport(
        producerTransportParams
      );

      producerTransport.on(
        'connect',
        async ({dtlsParameters}, callback, errback) => {
          try {
            const data = await socket.request('connectTransport', {
              dtlsParameters,
              transportId: producerTransportParams.id
            });
            callback(data);
          } catch (err) {
            errback(err);
          }
        }
      );

      producerTransport.on(
        'produce',
        async ({kind, rtpParameters}, callback, errback) => {
          try {
            const {producerId} = await socket.request('produce', {
              producerTransportId: producerTransport.id,
              kind,
              rtpParameters
            });
            return callback({id: producerId});
          } catch (err) {
            return errback(err);
          }
        }
      );

      producerTransport.on(
        'connectionstatechange',
        state => {
          if (state === 'failed') producerTransport.close();
        }
      );

      const consumerTransportParams = await socket
        .request('createWebRtcTransport');

      consumerTransport = device
        .createRecvTransport(consumerTransportParams);

      consumerTransport.on(
        'connect',
        async ({dtlsParameters}, callback, errback) => {
          try {
            await socket.request('connectTransport', {
              transportId: consumerTransport.id,
              dtlsParameters
            });
            return callback();
          } catch (err) {
            return errback(err);
          }
        }
      );

      consumerTransport.on(
        'connectionstatechange',
        state => {
          if (state === 'failed') consumerTransport.close();
        }
      );

    }

    async function produce(type = 'audioType', deviceId = 'default') {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: {deviceId},
        video: false
      });
      const track = stream.getAudioTracks()[0];

      const producer = await producerTransport.produce({track});
      console.log('Producer', producer);
    }
  
    async function consume(producerId) {
      const {rtpCapabilities} = device;

      const {id, kind, rtpParameters} = await socket.request('consume', {
        rtpCapabilities,
        consumerTransportId: consumerTransport.id,
        producerId
      });

      const consumer = await consumerTransport.consume({
        id,
        producerId,
        kind,
        rtpParameters,
        codecOptions: {}
      });

      const stream = new MediaStream();
      stream.addTrack(consumer.track);

      const elem = document.createElement('audio');
      elem.srcObject = stream;
      elem.id = consumer.id;
      elem.playsinline = false;
      elem.autoplay = true;
      remoteAudios.appendChild(elem);

    }
  </script>
</body>
</html>